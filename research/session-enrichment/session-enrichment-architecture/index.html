
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Persistent memory for AI agents — search, think, recall across every conversation">
      
      
      
        <link rel="canonical" href="https://etanhey.github.io/brainlayer/research/session-enrichment/session-enrichment-architecture/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/logo.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Session-level enrichment architecture for BrainLayer - BrainLayer</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#session-level-enrichment-architecture-for-brainlayer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="BrainLayer" class="md-header__button md-logo" aria-label="BrainLayer" data-md-component="logo">
      
  <img src="../../../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BrainLayer
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Session-level enrichment architecture for BrainLayer
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/EtanHey/brainlayer" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    EtanHey/brainlayer
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="BrainLayer" class="md-nav__button md-logo" aria-label="BrainLayer" data-md-component="logo">
      
  <img src="../../../assets/logo.svg" alt="logo">

    </a>
    BrainLayer
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/EtanHey/brainlayer" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    EtanHey/brainlayer
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../mcp-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MCP Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../enrichment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Enrichment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data-locations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Locations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../enrichment-runbook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Enrichment Runbook
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-models-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Local Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../mcp-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MCP Config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-the-schema-should-blend-relational-precision-with-json-flexibility" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. The schema should blend relational precision with JSON flexibility
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-route-sessions-by-size-through-a-tiered-processing-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Route sessions by size through a tiered processing pipeline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-corrections-must-be-first-class-searchable-entities-not-embedded-json" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Corrections must be first-class searchable entities, not embedded JSON
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-three-pass-prompting-extracts-layered-metadata-without-overwhelming-the-llm" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Three-pass prompting extracts layered metadata without overwhelming the LLM
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-cross-session-pattern-detection-needs-both-real-time-dedup-and-periodic-batch-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Cross-session pattern detection needs both real-time dedup and periodic batch analysis
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-session-enrichment-should-reference-chunks-bidirectionally" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Session enrichment should reference chunks bidirectionally
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-lessons-from-zep-mem0-cognee-and-letta-shape-the-design" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Lessons from Zep, Mem0, Cognee, and Letta shape the design
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion-a-practical-implementation-roadmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conclusion: a practical implementation roadmap
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="session-level-enrichment-architecture-for-brainlayer">Session-level enrichment architecture for BrainLayer</h1>
<p>BrainLayer's next evolution should treat sessions as first-class analytical units with a hybrid flat-column/JSON schema, a tiered processing pipeline that routes sessions by size between Gemini Flash and local map-reduce, and a corrections-as-entities subsystem where user corrections graduate into reusable rules through spaced-repetition-inspired confidence scoring. This design draws on proven patterns from Zep's temporal knowledge graph, Mem0's AUDN memory loop, and Cognee's DataPoint model — adapted for SQLite with sqlite-vec and FTS5. The result: <strong>268K chunks across 800+ sessions become a searchable knowledge base</strong> that captures not just what happened, but what was learned, what failed, and what rules emerged.</p>
<hr />
<h2 id="1-the-schema-should-blend-relational-precision-with-json-flexibility">1. The schema should blend relational precision with JSON flexibility</h2>
<p>The central design tension is between queryable flat columns (for dashboards, filtering, aggregation) and flexible JSON columns (for variable-length arrays like decisions, corrections, and tool stats). The right answer is a hybrid: <strong>flat columns for anything you filter or sort on, JSON for everything else</strong>, with SQLite generated columns bridging the gap when a JSON field later needs indexing.</p>
<p>A single <code>session_enrichments</code> table works best here since the relationship is strictly 1:1 (one enrichment per session). Normalization into separate tables is warranted only for many-to-many relationships like topics and tool usage, where you need efficient reverse lookups ("find all sessions about TypeScript" or "aggregate Bash tool success rates").</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">session_enrichments</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="c1">-- Identity</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTOINCREMENT</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="n">session_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="n">file_path</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="n">enrichment_version</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="n">enrichment_model</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="n">enrichment_timestamp</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="p">(</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-%dT%H:%M:%fZ&#39;</span><span class="p">,</span><span class="s1">&#39;now&#39;</span><span class="p">)),</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="c1">-- Timing (flat — for temporal queries)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="n">session_start_time</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">    </span><span class="n">session_end_time</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="n">duration_seconds</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">    </span><span class="c1">-- Message dynamics (flat — for aggregation dashboards)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="n">message_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">    </span><span class="n">user_message_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">    </span><span class="n">assistant_message_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">    </span><span class="n">tool_call_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">    </span><span class="n">total_input_tokens</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">    </span><span class="n">total_output_tokens</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">    </span><span class="n">compaction_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">    </span><span class="c1">-- Content analysis (flat — for filtering)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">    </span><span class="n">session_summary</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">    </span><span class="n">primary_intent</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">    </span><span class="n">narrative_arc</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">    </span><span class="n">complexity_score</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">CHECK</span><span class="p">(</span><span class="n">complexity_score</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">    </span><span class="n">outcome</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">CHECK</span><span class="p">(</span><span class="n">outcome</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span><span class="s1">&#39;partial_success&#39;</span><span class="p">,</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span><span class="s1">&#39;abandoned&#39;</span><span class="p">,</span><span class="s1">&#39;ongoing&#39;</span><span class="p">)),</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">    </span><span class="c1">-- Content analysis (JSON — variable-length, read-heavy)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="w">    </span><span class="n">secondary_intents</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="w">    </span><span class="n">topic_tags</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="w">    </span><span class="n">topic_evolution</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="w">    </span><span class="c1">-- Quality scores (flat — for dashboards and alerts)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="w">    </span><span class="n">session_quality_score</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">CHECK</span><span class="p">(</span><span class="n">session_quality_score</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="w">    </span><span class="n">ai_effectiveness_score</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">CHECK</span><span class="p">(</span><span class="n">ai_effectiveness_score</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="w">    </span><span class="n">tool_usage_quality_score</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">CHECK</span><span class="p">(</span><span class="n">tool_usage_quality_score</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="w">    </span><span class="n">frustration_level</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">CHECK</span><span class="p">(</span><span class="n">frustration_level</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="w">    </span><span class="n">success_rate</span><span class="w"> </span><span class="nb">REAL</span><span class="w"> </span><span class="k">CHECK</span><span class="p">(</span><span class="n">success_rate</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="w">    </span><span class="c1">-- Quality narratives (text — for human reading)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="w">    </span><span class="n">what_worked</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="w">    </span><span class="n">what_failed</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="w">    </span><span class="n">quality_justification</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="w">    </span><span class="c1">-- Decisions and corrections (JSON — variable-length arrays)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="w">    </span><span class="n">decisions_made</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="w">    </span><span class="n">corrections</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="w">    </span><span class="n">repeated_instructions</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="w">    </span><span class="n">frustration_signals</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="w">    </span><span class="c1">-- Knowledge (JSON — flexible structured data)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="w">    </span><span class="n">new_knowledge</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="w">    </span><span class="n">rules_established</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="w">    </span><span class="c1">-- Tool usage (JSON — per-tool stats)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="w">    </span><span class="n">tool_usage_stats</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="w">    </span><span class="n">most_used_tools</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="w">    </span><span class="n">tool_failures</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="w">    </span><span class="c1">-- Embedding for semantic search</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="w">    </span><span class="n">summary_embedding</span><span class="w"> </span><span class="nb">BLOB</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a><span class="p">);</span>
</code></pre></div>
<p>The JSON columns use SQLite's <code>json_each()</code> table-valued function for querying. When a JSON field becomes a frequent filter target, promote it without migration:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">-- Note: tool_usage_stats stores a JSON array (e.g., [{&quot;tool_name&quot;: &quot;Read&quot;, &quot;count&quot;: 42}])</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="c1">-- Default should be &#39;[]&#39; not &#39;{}&#39; to match this array access pattern</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">session_enrichments</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">primary_tool</span><span class="w"> </span><span class="nb">TEXT</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="k">GENERATED</span><span class="w"> </span><span class="n">ALWAYS</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="n">json_extract</span><span class="p">(</span><span class="n">tool_usage_stats</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;$[0].tool_name&#39;</span><span class="p">))</span><span class="w"> </span><span class="n">VIRTUAL</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_primary_tool</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">session_enrichments</span><span class="p">(</span><span class="n">primary_tool</span><span class="p">);</span>
</code></pre></div>
<p><strong>Three supporting tables handle many-to-many relationships and the processing pipeline.</strong> <code>session_topics</code> enables reverse lookups by topic. <code>session_tool_usage</code> enables per-tool analytics across sessions. <code>enrichment_jobs</code> tracks the multi-pass processing state, storing intermediate outputs from each pass so failed jobs can resume without reprocessing.</p>
<p>For full-text search, an FTS5 virtual table in content-sync mode indexes the narrative fields (summary, what_worked, what_failed, quality_justification) with Porter stemming. Triggers keep it synchronized. For vector search, sqlite-vec stores the summary embedding as a BLOB in the main table — at <strong>268K rows with 384-dim float32 vectors, brute-force cosine similarity runs in 50–200ms</strong>, which is acceptable for batch analysis and tolerable for interactive queries. Binary quantization (384 bits instead of 384 floats) can accelerate this 30× if needed.</p>
<hr />
<h2 id="2-route-sessions-by-size-through-a-tiered-processing-pipeline">2. Route sessions by size through a tiered processing pipeline</h2>
<p>The fundamental constraint is that sessions range from a few thousand tokens to 200K+, and the available models span from an 8K-context local LLM to Gemini Flash's 1M context window. Research on long-context LLM performance reveals a critical insight: <strong>advertised context windows are not effective context windows</strong>. Gemini Flash shows reliable performance up to ~100K tokens, but developer reports indicate degradation after that, with "lost in the middle" effects causing missed or confused information.</p>
<p>The optimal architecture is a three-tier routing system:</p>
<p><strong>Tier 1 (≤100K tokens, ~60–70% of sessions): Full-context Gemini Flash.</strong> Send the entire session in a single API call with structured extraction prompts. This produces the highest quality results with the simplest implementation. Place the transcript first in the prompt and extraction instructions last — Anthropic's research shows <strong>queries at the end of long contexts improve quality by up to 30%</strong>.</p>
<p><strong>Tier 2 (100K–500K tokens): Chunked Gemini Flash.</strong> Split into 2–5 overlapping segments with 15% overlap, process each segment, then run a lightweight merge/reconciliation pass. Split on message boundaries, never mid-message. Include speaker metadata and timestamps in the overlap region for context continuity.</p>
<p><strong>Tier 3 (&gt;500K tokens or rate-limited): Map-reduce with local LLM.</strong> The LLM×MapReduce approach from Tsinghua University (2024) is the gold standard here. Each chunk gets a structured extraction pass (the "map") producing metadata plus a <strong>confidence score</strong>. The "reduce" phase merges results using confidence-weighted reconciliation. Key finding: LLM×MapReduce with a small model (4B parameters) outperformed 70B-scale models on long-context benchmarks, because the small model processes focused chunks more accurately than a large model processes diffuse context.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">route_session</span><span class="p">(</span><span class="n">token_count</span><span class="p">,</span> <span class="n">gemini_available</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="k">if</span> <span class="n">gemini_available</span> <span class="ow">and</span> <span class="n">token_count</span> <span class="o">&lt;=</span> <span class="mi">100_000</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>        <span class="k">return</span> <span class="s2">&quot;gemini-full-context&quot;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="k">elif</span> <span class="n">gemini_available</span> <span class="ow">and</span> <span class="n">token_count</span> <span class="o">&lt;=</span> <span class="mi">500_000</span><span class="p">:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>        <span class="k">return</span> <span class="s2">&quot;gemini-chunked&quot;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>        <span class="k">return</span> <span class="s2">&quot;local-map-reduce&quot;</span>
</code></pre></div>
<p>For the local map-reduce path with GLM-4.7-Flash's 8K context: use <strong>4,000–6,000 token chunks with 15–20% overlap</strong>, split on message boundaries. This leaves room for the extraction prompt and output tokens. Each map output should include a rationale, extracted fields, and a per-field confidence score. The reduce phase can use either Gemini (if available) or iterative local merging.</p>
<p><strong>Cost and throughput for 800 sessions via Gemini Flash free tier</strong>: not feasible. At 20–100 requests per day on the free tier, processing would take <strong>8–40 days</strong>. Paid Tier 1 (just enabling billing, no minimum) costs roughly <strong>$0.30/M input tokens</strong>. Processing all 800 sessions (estimated 160M input tokens) costs approximately <strong>$52 total, or ~$26 via the Batch API</strong> at 50% discount. This is the pragmatic choice. Alternatively, the Gemini CLI provides dramatically better free-tier limits (60 RPM, 1,000 RPD).</p>
<hr />
<h2 id="3-corrections-must-be-first-class-searchable-entities-not-embedded-json">3. Corrections must be first-class searchable entities, not embedded JSON</h2>
<p>This is the most consequential architectural decision. Research across Zep, Mem0, Cognee, and knowledge graph literature converges on a clear answer: <strong>corrections, learnings, and rules deserve their own table with their own lifecycle</strong>. Embedding them only as JSON arrays inside session enrichments makes them invisible to cross-session analysis.</p>
<p>The key insight comes from Zep/Graphiti's temporal knowledge graph: facts change over time, and the system must track not just what's currently true but how knowledge evolved. Corrections follow a natural graduation pipeline:</p>
<ul>
<li><strong>Correction</strong> (single instance, session-bound) → seen once, low confidence</li>
<li><strong>Pattern</strong> (2–3 occurrences across sessions) → reinforced, growing confidence  </li>
<li><strong>Preference</strong> (stable, high confidence) → consistent across many sessions</li>
<li><strong>Rule</strong> (permanent, always applied) → explicitly confirmed or 5+ consistent occurrences</li>
</ul>
<p>This maps to a spaced-repetition-inspired confidence model: <code>effective_weight = base_confidence × (reinforcement_count ^ growth_factor) × e^(-days_since_last_use / half_life)</code>. Corrections that aren't reinforced decay; those that recur strengthen.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">corrections</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTOINCREMENT</span><span class="p">,</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="n">source_session_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="n">source_chunk_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="n">correction_type</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">        </span><span class="c1">-- preference, factual, style, process, tool_usage</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="n">original_behavior</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">               </span><span class="c1">-- what the agent did wrong</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="n">corrected_behavior</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">     </span><span class="c1">-- what the user wanted</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="n">rule_text</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">              </span><span class="c1">-- normalized, reusable rule statement</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="n">confidence</span><span class="w"> </span><span class="nb">REAL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="n">reinforcement_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="n">half_life_days</span><span class="w"> </span><span class="nb">REAL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">30</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">    </span><span class="n">first_seen_at</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">    </span><span class="n">last_seen_at</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;correction&#39;</span><span class="p">,</span><span class="w">     </span><span class="c1">-- correction → pattern → preference → rule</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">    </span><span class="n">tags</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">    </span><span class="n">embedding</span><span class="w"> </span><span class="nb">BLOB</span><span class="p">,</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">source_session_id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">session_enrichments</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="p">);</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">correction_links</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">    </span><span class="n">source_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">corrections</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="w">    </span><span class="n">target_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">corrections</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">    </span><span class="n">link_type</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">              </span><span class="c1">-- duplicate, related, supersedes, contradicts</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">    </span><span class="n">similarity_score</span><span class="w"> </span><span class="nb">REAL</span><span class="p">,</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span><span class="w"> </span><span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="p">);</span>
</code></pre></div>
<p><strong>Why separate from session_enrichments?</strong> Three reasons. First, corrections need their own embeddings for semantic deduplication — you need to find "user said don't use var" in session 47 when the same correction appears in session 312. Second, corrections accumulate metadata over their lifetime (reinforcement_count, confidence) that doesn't belong to any single session. Third, the <code>correction_links</code> table enables a graph of related corrections that spans sessions.</p>
<p>The <code>rule_text</code> field is critical: it's the <strong>normalized, agent-consumable statement</strong> derived from the raw correction context. "No, use const not var" becomes "Always use const instead of var in JavaScript/TypeScript files." This normalization step happens during extraction and makes corrections directly injectable into future agent prompts.</p>
<p>Mem0's AUDN (Add/Update/Delete/Noop) pattern provides the right operational model for processing new corrections: embed the candidate, search existing corrections by cosine similarity, and use the LLM to decide whether to ADD a new correction, UPDATE an existing one (incrementing reinforcement_count), DELETE a contradicted one, or NOOP.</p>
<hr />
<h2 id="4-three-pass-prompting-extracts-layered-metadata-without-overwhelming-the-llm">4. Three-pass prompting extracts layered metadata without overwhelming the LLM</h2>
<p>Research from Anthropic, OpenAI, and conversation intelligence platforms (Gong, Chorus, CallMiner) converges on a principle: <strong>single-task prompts outperform multi-task prompts for extraction quality</strong>. A three-pass strategy gives each pass the LLM's full attention on one cognitive task.</p>
<p><strong>Pass 1 — Structure and narrative</strong> (broad understanding). Extract: session summary, primary intent, topic evolution, narrative arc, complexity score, outcome, message counts. This pass establishes the "what happened" frame that contextualizes everything else. The prompt should use XML tags for structure, place the transcript first with instructions after, and request JSON output matching a strict schema.</p>
<p><strong>Pass 2 — Detailed signal extraction</strong> (specific signals). Takes Pass 1 output as context. Extract: decisions made (with rationale and outcome), user corrections (what was wrong, what was right, severity), repeated instructions, frustration signals (explicit and implicit), tool usage statistics, new knowledge established, rules the user expressed. This pass benefits from the narrative frame established in Pass 1, allowing it to focus on fine-grained extraction without needing to understand the overall arc.</p>
<p><strong>Pass 3 — Quality scoring</strong> (judgment). Takes Pass 1 and Pass 2 outputs — not the full transcript. Score: session quality, AI effectiveness, tool usage quality, communication quality, recovery quality. Also produce what_worked, what_failed, and success_rate. This pass works from distilled information, making it suitable for a smaller model.</p>
<p>Key prompting techniques that significantly improve extraction quality:</p>
<ul>
<li><strong>"Quote before answering"</strong>: Instruct the LLM to quote relevant transcript excerpts before making claims. This grounds responses in evidence and dramatically reduces hallucination on long documents.</li>
<li><strong>Selective attention instructions</strong>: "Focus primarily on user messages expressing intent, moments where direction changes, error/failure events, and the final outcome. Skim routine tool outputs confirming success."</li>
<li><strong>Temperature 0.0–0.2</strong> for extraction tasks ensures factual, deterministic outputs.</li>
<li><strong>Structured output enforcement</strong>: Use JSON schema constraints (Gemini's <code>response_schema</code> or function calling) for guaranteed schema compliance.</li>
</ul>
<p>For the map-reduce path, Pass 1 runs independently on each chunk (the "map"). Passes 2 and 3 run on the merged Pass 1 output (the "reduce"). Each map output includes per-field confidence scores for conflict resolution during merging.</p>
<hr />
<h2 id="5-cross-session-pattern-detection-needs-both-real-time-dedup-and-periodic-batch-analysis">5. Cross-session pattern detection needs both real-time dedup and periodic batch analysis</h2>
<p>Detecting that the same correction appears across sessions requires two complementary mechanisms: <strong>real-time similarity matching during ingestion</strong> and <strong>periodic batch clustering</strong> for pattern discovery.</p>
<p><strong>Real-time dedup during correction ingestion</strong> uses sqlite-vec. When a new correction is extracted, embed it and query the vec_corrections table for neighbors within cosine distance <strong>&lt; 0.15</strong> (i.e., cosine similarity &gt; 0.85 — <code>vec_distance_cosine</code> returns distance where lower = more similar). If a near-duplicate exists, invoke the AUDN loop: the LLM decides whether to merge (incrementing reinforcement_count and updating confidence) or keep as distinct.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">-- Find similar existing corrections (distance &lt; 0.15 = similarity &gt; 0.85)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">rule_text</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">confidence</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">reinforcement_count</span><span class="p">,</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">       </span><span class="n">vec_distance_cosine</span><span class="p">(</span><span class="n">vc</span><span class="p">.</span><span class="n">embedding</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="n">new_embedding</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">distance</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="k">FROM</span><span class="w"> </span><span class="n">vec_corrections</span><span class="w"> </span><span class="n">vc</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">corrections</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vc</span><span class="p">.</span><span class="n">correction_id</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">vec_distance_cosine</span><span class="p">(</span><span class="n">vc</span><span class="p">.</span><span class="n">embedding</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="n">new_embedding</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">15</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">distance</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</code></pre></div>
<p><strong>Periodic batch analysis</strong> (nightly or after every N sessions) handles broader pattern discovery that real-time matching misses:</p>
<ol>
<li>Fetch all corrections added since the last batch run</li>
<li>Run HDBSCAN clustering on the full correction embedding space (HDBSCAN is preferred over K-means because it auto-detects cluster count and handles varying cluster densities)</li>
<li>For each cluster, generate a descriptive label using the LLM</li>
<li>Within clusters, merge near-duplicates (cosine similarity &gt; 0.85)</li>
<li>Promote corrections exceeding confidence thresholds (correction → pattern at 2+ occurrences, pattern → preference at consistent cross-session presence, preference → rule at 5+ reinforcements or explicit user confirmation)</li>
<li>Decay old corrections not reinforced recently (reduce effective_weight)</li>
<li>Generate a summary report of emerging patterns</li>
</ol>
<p>This mirrors how <strong>log analysis systems</strong> (Amazon CloudWatch Patterns, LogCluster) detect recurring issues: knowledge base initialization followed by online matching against existing clusters, with unmatched items seeding new clusters. Customer support ticket clustering research confirms this two-phase approach (real-time classification + periodic re-clustering) as the most practical architecture.</p>
<p>For the 268K-row scale, UMAP dimensionality reduction before HDBSCAN improves clustering quality on high-dimensional embeddings. The batch job stores cluster assignments in a <code>correction_clusters</code> table, enabling queries like "show me the top 10 most reinforced correction clusters."</p>
<hr />
<h2 id="6-session-enrichment-should-reference-chunks-bidirectionally">6. Session enrichment should reference chunks bidirectionally</h2>
<p>The relationship between session-level and chunk-level enrichment should be <strong>bidirectional but loosely coupled</strong>. Session enrichments reference specific chunk IDs where key events occurred (a correction at chunk #47, a decision at chunk #112), and chunk-level retrieval can be enhanced by session-level metadata.</p>
<p><strong>Session → Chunk references</strong>: The JSON arrays in session_enrichments (decisions_made, corrections, frustration_signals) should include a <code>chunk_id</code> or <code>message_index</code> field pointing to the specific chunk where the event was detected. This enables drill-down: a user investigating a low-quality session can jump directly to the problematic exchange.</p>
<p><strong>Chunk → Session enhancement</strong>: When retrieving chunks via semantic search (the primary BrainLayer use case), session-level metadata acts as a <strong>reranking signal</strong>. A chunk from a session with quality_score=9 and outcome=success is more likely to contain reliable information than the same semantic match from a session with quality_score=2 and outcome=failure. Implement this as a weighted score:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">.</span><span class="n">session_quality_score</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">.</span><span class="n">outcome</span><span class="p">,</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">semantic_score</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">session_quality_score</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">     </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="n">se</span><span class="p">.</span><span class="n">outcome</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;partial_success&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">enhanced_score</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="k">FROM</span><span class="w"> </span><span class="n">chunks</span><span class="w"> </span><span class="k">c</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">session_enrichments</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">se</span><span class="p">.</span><span class="n">session_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">session_id</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">enhanced_score</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div>
<p>This pattern draws from Kernel Memory's tags system (metadata attached at the document level flows down to enhance chunk-level retrieval) and Cognee's strict provenance linking (inferred information always links back to source documents). The key principle is that <strong>session context enriches chunk retrieval without replacing it</strong> — chunks remain the primary unit of semantic search, but session metadata provides quality signals and navigational context.</p>
<p><strong>Do not store session-level embeddings in the same vec0 table as chunk embeddings.</strong> They exist at different semantic granularities. Use separate vec0 tables (or separate embedding columns) so similarity searches within each level remain clean.</p>
<hr />
<h2 id="7-lessons-from-zep-mem0-cognee-and-letta-shape-the-design">7. Lessons from Zep, Mem0, Cognee, and Letta shape the design</h2>
<p>Each existing project contributes a distinct architectural insight that BrainLayer should incorporate:</p>
<p><strong>Zep/Graphiti's bi-temporal model</strong> is the most sophisticated approach to handling changing facts. Every fact carries four timestamps: <code>t_created</code>, <code>t_expired</code> (ingestion time) and <code>t_valid</code>, <code>t_invalid</code> (event time). When new information contradicts old, the old edge gets invalidated rather than deleted. For BrainLayer's corrections table, this translates to <code>first_seen_at</code>, <code>last_seen_at</code>, and <code>invalidated_at</code> columns — never delete corrections, only mark them superseded.</p>
<p><strong>Mem0's incremental AUDN loop</strong> (Add/Update/Delete/Noop) provides the operational model for processing corrections. Rather than reanalyzing entire sessions when new information arrives, process corrections incrementally: embed, search, decide operation. This scales to continuous enrichment as new sessions arrive without reprocessing the entire corpus.</p>
<p><strong>Cognee's Memify pattern</strong> — post-processing that compresses repeated patterns from session traces into reusable meta-structures — maps directly to the batch clustering pipeline described above. Cognee also validates that memory updates actually improve agent performance, a principle BrainLayer should adopt: track whether surfacing a correction during retrieval actually prevents the error from recurring.</p>
<p><strong>Letta/MemGPT's two-tier memory</strong> (editable core memory + archival vector store) suggests that BrainLayer's most important corrections and rules should be promoted to a "core rules" set that's always injected into the agent prompt, while the full corrections database serves as searchable archival memory.</p>
<p><strong>LangMem's schema-based extraction</strong> using Pydantic models for structured memory types (semantic, episodic, procedural) provides a clean software pattern: define extraction schemas as data classes, use them to constrain LLM output, and store the validated results directly in SQLite.</p>
<p>One pattern all projects share: <strong>LLM-based conflict resolution over brittle rules</strong>. When two corrections contradict each other or a new fact conflicts with an old one, delegate the resolution decision to the LLM rather than building complex rule-based logic. This is both more robust and simpler to maintain.</p>
<hr />
<h2 id="conclusion-a-practical-implementation-roadmap">Conclusion: a practical implementation roadmap</h2>
<p>The system described here is ambitious but modular — each component delivers value independently and can be built incrementally. <strong>Start with the session_enrichments table and the three-pass Gemini pipeline</strong>, which immediately makes 800+ sessions searchable by quality, intent, outcome, and narrative. Add the corrections table and real-time dedup second, since this is where the highest long-term value accumulates. Add batch clustering and correction graduation third, once enough corrections exist to make pattern detection meaningful.</p>
<p>Three non-obvious insights emerged from this research. First, <strong>effective context windows are roughly half of advertised context windows</strong> — plan the tiered routing around 100K tokens, not 1M. Second, <strong>the correction graduation pipeline (correction → pattern → preference → rule) is the single most valuable feature</strong> for an AI agent memory system, yet no existing open-source project implements it fully. Third, <strong>session-level quality scores as chunk reranking signals</strong> create a virtuous cycle: high-quality sessions get their chunks surfaced more often, which means the agent learns from its best interactions rather than its worst.</p>
<p>The total investment to process all 800 existing sessions through Gemini Flash Batch API is approximately <strong>$26</strong>. The schema handles 268K+ rows comfortably within SQLite's capabilities, with sqlite-vec providing 50–200ms vector search and FTS5 enabling instant keyword search. The architecture is designed to grow: as BrainLayer indexes more sessions, the corrections knowledge base becomes increasingly valuable, with each new correction either reinforcing existing patterns or revealing new ones.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "content.code.copy", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>